<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>주택지원 신청 - LOFA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background: #f8f9fa; padding: 30px; font-family: 'Malgun Gothic', sans-serif; }
        .form-card { background: white; border-radius: 15px; padding: 40px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); max-width: 800px; margin: auto; }
        .section-title { border-left: 5px solid #198754; padding-left: 15px; margin-bottom: 25px; font-weight: bold; color: #198754; }
        .info-box { background: #f0fff4; border: 1px solid #c6f6d5; padding: 15px; border-radius: 10px; font-size: 0.9rem; color: #22543d; }
    </style>
</head>
<body>

<div class="form-card shadow">
    <h3 class="text-center fw-bold text-success mb-4">
        {% if edit_mode %} <i class="bi bi-pencil-square"></i> 주택지원 신청 내역 수정 {% else %} 🏠 직원 주택지원 신청서 {% endif %}
    </h3>

    <form id="housingForm" enctype="multipart/form-data">
        <input type="hidden" name="app_id" value="{{ data.app_id if edit_mode else '' }}">
        <input type="hidden" name="type" value="주택지원">
        
        <div class="section-title">1. 신청인 정보</div>
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <label class="fw-bold small">성명</label>
                <input type="text" name="user_name" class="form-control bg-light" value="{{ data.성명 if data else user_name }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">사번</label>
                <input type="text" name="user_id" class="form-control bg-light" value="{{ data.사번 if data else user_id }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">부서</label>
                <input type="text" name="user_dept" class="form-control bg-light" value="{{ data.부서 if data else user_dept }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">직급</label>
                <input type="text" name="position" class="form-control bg-light" value="{{ data.직급 if data else user_rank }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">입사일</label>
                <input type="text" name="joinDate" class="form-control bg-light" value="{{ data.입사일 if data else user_join_date }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">전화번호</label>
                <input type="text" name="phone" class="form-control bg-light" value="{{ data.전화번호 if data else '' }}" readonly required>
            </div>
        </div>

        <div class="section-title">2. 주택지원 상세내용</div>
        <div class="row g-3 mb-4">
            <div class="col-md-12">
                <label class="fw-bold small">지원 구분</label>
                <select name="target_name" class="form-select" required>
                    <option value="">선택하세요</option>
                    <option value="주택자금 대출지원" {% if data and data.대상자성명 == '주택자금 대출지원' %}selected{% endif %}>주택자금 대출지원</option>
                    <option value="임차보증금 지원" {% if data and data.대상자성명 == '임차보증금 지원' %}selected{% endif %}>임차보증금 지원</option>
                    <option value="기타 주택지원" {% if data and data.대상자성명 == '기타 주택지원' %}selected{% endif %}>기타 주택지원</option>
                </select>
            </div>
            
            <div class="col-md-6">
                <label class="fw-bold small text-success">신청 금액</label>
                <div class="input-group">
                    <input type="number" name="amount" class="form-control fw-bold text-end" value="{{ data.amount if data.amount else (data.신청금액 if data.신청금액 else '') }}" required>
                    <span class="input-group-text bg-white">원</span>
                </div>
            </div>


            <div class="col-md-6">
                <label class="fw-bold small">지급 계좌 (은행/계좌번호/예금주)</label>
                <input type="text" name="account" class="form-control" value="{{ data.account if data.account else (data.계좌번호 if data.계좌번호 else '') }}" placeholder="은행/계좌번호/예금주" required>
            </div>
            
            <div class="col-12 mt-3">
                <label class="fw-bold small"><i class="bi bi-paperclip"></i> 증빙서류 첨부 (주택 구입자금의 차입사실(계약서 등), 압축하여 1개 파일로 제출)</label>
                <input type="file" name="attachment" class="form-control">
                {% if edit_mode and data.첨부파일 %}
                <div class="mt-2 small text-muted">기존 파일: <span class="text-success fw-bold">{{ data.첨부파일 }}</span></div>
                {% endif %}
            </div>
        </div>

        <div class="info-box mb-4">
            <i class="bi bi-info-circle-fill"></i> 
            <b>안내사항:</b> 주택지원 신청의 경우 관련 계약서 사본 등 증빙 자료를 반드시 스캔하여 첨부해 주시기 바랍니다.
        </div>

        <div class="section-title">3. 개인정보 수집 및 이용 동의</div>
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-body bg-light small" style="max-height: 150px; overflow-y: auto;">
                <p class="fw-bold mb-1">[개인정보 수집 및 이용에 대한 동의]</p>
                <p class="mb-2">LOFA 사내근로복지기금 지원 신청과 관련하여 아래와 같이 귀하의 개인정보를 수집 및 이용하고자 합니다.</p>
                <ul class="mb-2">
                    <li><strong>수집항목:</strong> 성명, 사번, 부서, 직급, 전화번호, 입사일, 계좌번호, 신청 금액 및 사유, 증빙서류 내 포함된 개인정보</li>
                    <li><strong>수집목적:</strong> 복지기금 지원 대상 확인, 지급 심사 및 처리, 결과 통지, 기금 운영 통계 분석</li>
                    <li><strong>보유 및 이용기간:</strong> 복지기금 운영 규정 및 관련 법령(근로복지기본법 등)에 따른 보존 기간 종료 시까지</li>
                </ul>
                <p class="mb-0 text-muted">※ 귀하는 개인정보 수집 및 이용에 대한 동의를 거부할 권리가 있습니다. 다만, 동의를 거부할 경우 복지기금 지원 신청 및 지급이 제한될 수 있습니다.</p>
            </div>
            <div class="card-footer bg-white border-top-0">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="privacyConsent" name="privacy_consent" required>
                    <label class="form-check-label fw-bold" for="privacyConsent">
                        위의 개인정보 수집 및 이용에 동의합니다. (필수)
                    </label>
                </div>
            </div>
        </div>

        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-success btn-lg shadow fw-bold">
                {% if edit_mode %} <i class="bi bi-check2-circle"></i> 수정 완료 및 재제출 {% else %} <i class="bi bi-house-door-fill"></i> 주택지원 신청하기 {% endif %}
            </button>
            <a href="/my_status" class="btn btn-outline-secondary">취소하고 돌아가기</a>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.getElementById('housingForm').onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);

        try {
            const res = await fetch('/submit', { method: 'POST', body: formData });
            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`서버 응답 오류 (${res.status}): ${errorText.substring(0, 100)}`);
            }
            const result = await res.json();
            
            if(result.status === 'success') {
                alert(result.message || '신청서가 정상적으로 제출되었습니다.');
                window.location.href = '/my_status';
            } else {
                alert('제출 오류: ' + result.message);
            }
        } catch (err) {
            console.error('Submission error:', err);
            alert('제출 중 오류가 발생했습니다: ' + err.message);
        }
    };
</script>
</body>
</html>