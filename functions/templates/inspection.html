<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>선진산업시찰 신청 - LOFA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background: #f8f9fa; padding: 30px; font-family: 'Malgun Gothic', sans-serif; }
        .form-card { background: white; border-radius: 15px; padding: 40px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); max-width: 900px; margin: auto; }
        .section-title { border-left: 5px solid #007bff; padding-left: 15px; margin-bottom: 25px; font-weight: bold; color: #007bff; }
        .info-box { background: #f0f7ff; border: 1px solid #cfe2ff; padding: 15px; border-radius: 10px; font-size: 0.9rem; color: #084298; }
    </style>
</head>
<body>

<div class="form-card shadow">
    <h3 class="text-center fw-bold text-primary mb-4">
        {% if data and data.app_id %} 
            <i class="bi bi-pencil-square"></i> 산업시찰 신청 수정 
        {% else %} 
            ✈️ 선진산업시찰 신청서 
        {% endif %}
    </h3>

    <form id="inspectionForm" enctype="multipart/form-data">
        <input type="hidden" name="app_id" value="{{ data.app_id if data and data.app_id else '' }}">
        <input type="hidden" name="type" value="선진산업시찰">
        
        <div class="section-title">1. 신청인 정보</div>
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <label class="fw-bold small">성명</label>
                <input type="text" name="user_name" class="form-control bg-light" value="{{ data.성명 if data else user_name }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">사번</label>
                <input type="text" name="user_id" class="form-control bg-light" value="{{ data.사번 if data else user_id }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">부서</label>
                <input type="text" name="user_dept" class="form-control bg-light" value="{{ data.부서 if data else user_dept }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">직급</label>
                <input type="text" name="position" class="form-control bg-light" value="{{ data.직급 if data else user_rank }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">입사일</label>
                <input type="text" name="joinDate" class="form-control bg-light" value="{{ data.입사일 if data else user_join_date }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">전화번호</label>
                <input type="text" name="phone" class="form-control bg-light" value="{{ data.전화번호 if data else '' }}" readonly required>
            </div>
        </div>

        <div class="section-title">2. 시찰 상세내역</div>
        <div class="row g-3 mb-4">
            <div class="col-md-12">
                <label class="fw-bold small">시찰 장소 (국가/도시)</label>
                <input type="text" name="target_name" class="form-control" placeholder="예: 독일 뮌헨 등" value="{{ data.target_name if data.target_name else (data.대상자성명 if data.대상자성명 else '') }}" required>
            </div>
            <div class="col-md-12">
                <label class="fw-bold small">시찰 일정 및 목적</label>
                <textarea name="detail_text" class="form-control" rows="3" placeholder="시찰 기간 및 주요 방문 목적을 상세히 입력하세요." required>{{ data.detail_text if data.detail_text else (data.세부내용 if data.세부내용 else '') }}</textarea>
            </div>
            <div class="col-md-12">
                <label class="fw-bold small text-primary">신청 금액 (실 소요비용)</label>
                <div class="input-group">
                    <input type="number" name="amount" class="form-control fw-bold text-end" value="{{ data.amount if data.amount else (data.신청금액 if data.신청금액 else '') }}" required>
                    <span class="input-group-text bg-white">원</span>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <label class="fw-bold mb-1 small">지급 계좌번호 <span class="text-danger">*</span></label>
            <div class="row g-2">
                <div class="col-md-4">
                    <select id="bankSel" class="form-select" onchange="syncAcct()" required>
                        <option value="">-- 은행 선택 --</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" id="acctNum" class="form-control" placeholder="계좌번호 (숫자만)" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9]/g,'');syncAcct();" required>
                </div>
                <div class="col-md-4">
                    <input type="text" id="acctHolder" class="form-control" placeholder="예금주" oninput="syncAcct();" required>
                </div>
            </div>
            <input type="hidden" name="account" id="account" value="{{ data.account if data.account else (data.계좌번호 if data.계좌번호 else '') }}">
            <small class="text-muted mt-1 d-block"><i class="bi bi-info-circle"></i> 은행 선택 → 계좌번호 입력 → 예금주 입력</small>
        </div>

        <div class="section-title">3. 증빙서류 첨부</div>
        <div class="row g-3 mb-4">
            <div class="col-12">
                <div class="info-box mb-3">
                    <i class="bi bi-info-circle-fill"></i> 
                    <b>안내사항:</b> 시찰 계획서, 관련 공문 또는 항공/숙박 예약 내역을 첨부해 주세요.
                </div>
                <input type="file" name="attachment" class="form-control">
                {% if data and data.첨부파일 %}
                <div class="mt-2 small text-muted">현재 파일: <span class="text-primary fw-bold">{{ data.첨부파일 }}</span></div>
                {% endif %}
            </div>
        </div>

        <div class="section-title">4. 개인정보 수집 및 이용 동의</div>
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-body bg-light small" style="max-height: 150px; overflow-y: auto;">
                <p class="fw-bold mb-1">[개인정보 수집 및 이용에 대한 동의]</p>
                <p class="mb-2">LOFA 사내근로복지기금 지원 신청과 관련하여 아래와 같이 귀하의 개인정보를 수집 및 이용하고자 합니다.</p>
                <ul class="mb-2">
                    <li><strong>수집항목:</strong> 성명, 사번, 부서, 직급, 전화번호, 입사일, 계좌번호, 신청 금액 및 사유, 증빙서류 내 포함된 개인정보</li>
                    <li><strong>수집목적:</strong> 복지기금 지원 대상 확인, 지급 심사 및 처리, 결과 통지, 기금 운영 통계 분석</li>
                    <li><strong>보유 및 이용기간:</strong> 복지기금 운영 규정 및 관련 법령(근로복지기본법 등)에 따른 보존 기간 종료 시까지</li>
                </ul>
                <p class="mb-0 text-muted">※ 귀하는 개인정보 수집 및 이용에 대한 동의를 거부할 권리가 있습니다. 다만, 동의를 거부할 경우 복지기금 지원 신청 및 지급이 제한될 수 있습니다.</p>
            </div>
            <div class="card-footer bg-white border-top-0">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="privacyConsent" name="privacy_consent" required>
                    <label class="form-check-label fw-bold" for="privacyConsent">
                        위의 개인정보 수집 및 이용에 동의합니다. (필수)
                    </label>
                </div>
            </div>
        </div>

        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary btn-lg shadow fw-bold">
                {% if data and data.app_id %} 
                    <i class="bi bi-check2-circle"></i> 수정 완료 및 재제출 
                {% else %} 
                    <i class="bi bi-airplane-engines"></i> 시찰 신청하기 
                {% endif %}
            </button>
            <a href="/my_status" class="btn btn-outline-secondary">목록으로 돌아가기</a>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const BANKS=['KB국민은행','신한은행','우리은행','하나은행','NH농협은행','IBK기업은행','카카오뱅크','토스뱅크','SC제일은행','씨티은행','대구은행','부산은행','광주은행','전북은행','경남은행','제주은행','KDB산업은행','수협은행','새마을금고','신협','우체국','iM뱅크(구DGB)','기타'];
    function initBankSelect(){const sel=document.getElementById('bankSel');if(!sel)return;BANKS.forEach(b=>{const o=document.createElement('option');o.value=b;o.textContent=b;sel.appendChild(o);});}
    function syncAcct(){const b=(document.getElementById('bankSel')||{value:''}).value;const n=(document.getElementById('acctNum')||{value:''}).value;const h=(document.getElementById('acctHolder')||{value:''}).value;const hidden=document.getElementById('account');const cleanAcct=n.replace(/[^0-9]/g,'');if(hidden)hidden.value=(b&&cleanAcct&&h)?`${b}/${cleanAcct}/${h.trim()}`:''; }
    function loadAcct(str){if(!str)return;const p=str.split('/');const sel=document.getElementById('bankSel');if(sel&&p[0]){sel.value=p[0];if(!sel.value){const o=new Option(p[0],p[0],true,true);sel.appendChild(o);sel.value=p[0];}}const num=document.getElementById('acctNum');if(num&&p[1])num.value=p[1];const holder=document.getElementById('acctHolder');if(holder&&p[2])holder.value=p[2];syncAcct();}

    window.onload = function() {
        initBankSelect();
        loadAcct(`{{ data.account if data and data.account else (data.계좌번호 if data and data.계좌번호 else '') }}`);
    };

    document.getElementById('inspectionForm').onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);

        try {
            const res = await fetch('/submit', { method: 'POST', body: formData });
            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`서버 응답 오류 (${res.status}): ${errorText.substring(0, 100)}`);
            }
            const result = await res.json();
            
            if(result.status === 'success') {
                alert(result.message || '시찰 신청이 정상적으로 완료되었습니다.');
                window.location.href = '/my_status';
            } else {
                alert('오류 발생: ' + result.message);
            }
        } catch (err) {
            console.error('Submission error:', err);
            alert('제출 중 오류가 발생했습니다: ' + err.message);
        }
    };
</script>
</body>
</html>
