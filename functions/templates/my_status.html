<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>내 신청 현황 - LOFA 복지기금</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background: #f4f7f6; font-family: 'Malgun Gothic', sans-serif; padding-top: 50px; }
        .status-container { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); max-width: 1240px; margin: auto; }
        .table thead { background-color: #f8f9fa; border-top: 2px solid #dee2e6; }
        .badge-wait { background: #ffc107; color: #212529; font-weight: bold; }
        .badge-approve { background: #198754; color: white; font-weight: bold; }
        .badge-reject { background: #dc3545; color: white; font-weight: bold; }
        .badge-temp { background: #6c757d; color: white; font-weight: bold; }
        .badge-cancel { background: #e9ecef; color: #6c757d; font-weight: bold; border: 1px solid #dee2e6; }
        .btn-action { font-weight: bold; border-radius: 8px; transition: 0.2s; font-size: 0.85rem; }
        .table-hover tbody tr:hover { background-color: #fcfdff; }
        .year-selector { max-width: 150px; }
    </style>
</head>
<body>

<div class="container status-container">
    <div class="row mb-5">
        <div class="col-md-6">
            <h3 class="fw-bold m-0 text-dark">
                <i class="bi bi-file-earmark-person text-danger"></i> {{ user_name }}님 신청 현황
            </h3>
        </div>
        <div class="col-md-6 d-flex justify-content-md-end align-items-center gap-3 mt-3 mt-md-0">
            <div class="d-flex align-items-center gap-2">
                <label class="small fw-bold text-muted">조회 연도:</label>
                <select class="form-select form-select-sm year-selector shadow-sm" onchange="location.href='/my_status?year='+this.value">
                    {% for y in years %}
                    <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}년도</option>
                    {% endfor %}
                </select>
            </div>
            <a href="/" class="btn btn-sm btn-outline-dark shadow-sm">
                <i class="bi bi-house-door"></i> 메인으로
            </a>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="text-center">
                <tr>
                    <th style="width: 15%;">신청일시</th>
                    <th style="width: 12%;">구분</th>
                    <th style="width: 15%;">신청금액</th>
                    <th style="width: 10%;">상태</th>
                    <th style="width: 28%;">비고 / 반려사유</th>
                    <th style="width: 20%;">관리</th>
                </tr>
            </thead>
            <tbody>
                {% for app in applications %}
                <tr>
                    <td class="text-center small text-muted">{{ app.신청일시 }}</td>
                    <td class="text-center"><span class="badge border text-dark px-3 py-2">{{ app.구분 }}</span></td>
                    <td class="text-end fw-bold text-primary pe-4">
                        {{ "{:,}".format(app.신청금액|int if app.신청금액 else 0) }}원
                    </td>
                    <td class="text-center">
                        <span class="badge rounded-pill px-3 py-2 
                            {% if app.상태 == '대기' %}badge-wait
                            {% elif app.상태 == '승인' %}badge-approve
                            {% elif app.상태 == '임시저장' or app.상태 == '취소' %}badge-temp
                            {% else %}badge-reject{% endif %}">
                            {{ app.상태 }}
                        </span>
                    </td>
                    <td class="small px-3 text-center">
                        {% if app.상태 == '반려' %}
                            <span class="text-danger fw-bold"><i class="bi bi-exclamation-circle"></i> {{ app.반려의견 }}</span>
                        {% elif app.상태 == '대기' %}
                            <span class="text-muted small">검토 중입니다.</span>
                        {% elif app.상태 == '취소' %}
                            <span class="text-muted small text-decoration-line-through">사용자가 신청을 취소함</span>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <div class="d-flex justify-content-center gap-2">
                            {% if app.상태 == '대기' %}
                                <button class="btn btn-sm btn-outline-warning btn-action shadow-sm" 
                                        onclick="manageApp('{{ app.app_id }}', 'cancel')">
                                    <i class="bi bi-arrow-counterclockwise"></i> 신청취소
                                </button>
                            {% elif app.상태 == '임시저장' or app.상태 == '반려' or app.상태 == '취소' %}
                                <button class="btn btn-sm btn-primary btn-action shadow-sm" 
                                        onclick="editApp('{{ app.구분 }}', '{{ app.app_id }}')">
                                    <i class="bi bi-pencil-square"></i> 수정
                                </button>
                                <button class="btn btn-sm btn-danger btn-action shadow-sm" 
                                        onclick="manageApp('{{ app.app_id }}', 'delete')">
                                    <i class="bi bi-trash"></i> 삭제
                                </button>
                            {% else %}
                                <span class="text-success small fw-bold"><i class="bi bi-check-all"></i> 처리가 완료되었습니다.</span>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center py-5">
                        <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                        <p class="mt-3 text-muted">{{ selected_year }}년도 신청 내역이 없습니다.</p>
                        <a href="/" class="btn btn-sm btn-danger mt-2">첫 복지 신청하러 가기</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<footer class="text-center mt-5 text-muted small">
    © 2026 한국지방재정공제회(LOFA) 인프라팀 복지기금관리시스템
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 신청 관리(취소/삭제) 함수
    async function manageApp(appId, action) {
        if (!appId || appId === 'None') {
            alert("고유 식별자(ID)가 없습니다. 다시 시도해 주세요.");
            return;
        }

        const confirmMsg = action === 'delete' ? 
            '정말 이 신청 내역을 영구 삭제하시겠습니까?\n삭제된 데이터는 복구할 수 없습니다.' : 
            '신청을 취소하시겠습니까?\n취소하면 "임시저장" 상태가 되어 내용을 다시 수정할 수 있습니다.';
        
        if(!confirm(confirmMsg)) return;
        
        // FormData를 사용하여 app.py의 cancel_apply 경로로 전송
        const fd = new FormData();
        fd.append('app_id', appId);
        fd.append('action', action);

        try {
            const res = await fetch('/cancel_apply', {
                method: 'POST',
                body: fd
            });
            const result = await res.json();
            
            if(result.status === 'success') {
                alert(result.message);
                location.reload(); // 성공 시 화면 새로고침하여 상태 반영
            } else {
                alert('처리 실패: ' + result.message);
            }
        } catch (err) {
            console.error(err);
            alert('서버와 통신 중 오류가 발생했습니다.');
        }
    }

    // 수정 페이지 이동 함수
    function editApp(type, appId) {
        const map = {
            '의료비지원': 'medical', '장학금지원': 'scholarship', '경조비지원': 'congratulation',
            '선진산업시찰': 'inspection', '주택지원': 'housing', '복지연금': 'pension',
            '모성보호지원': 'maternity', '다자녀가정지원': 'multichild', '위로금지원': 'solace', 
            '생활복지지원': 'life_welfare', '근로자가족문화활동비': 'cultural_activity',
            '정기예방접종': 'vaccination', '대부신청': 'loan'
        };
        const fileName = map[type];
        if (fileName) {
            // 주소창에 edit_app_id를 붙여서 이동
            location.href = `/apply/${fileName}?edit_app_id=${appId}`;
        } else {
            alert('해당 항목의 수정 페이지를 찾을 수 없습니다.');
        }
    }
</script>

</body>
</html>