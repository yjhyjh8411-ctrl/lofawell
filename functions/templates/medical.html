<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì˜ë£Œë¹„ ì§€ì› ì‹ ì²­ - LOFA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background: #f8f9fa; padding: 30px; font-family: 'Malgun Gothic', sans-serif; }
        .form-card { background: white; border-radius: 15px; padding: 40px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); max-width: 900px; margin: auto; }
        .medical-row { background: #fffcfc; border: 1px solid #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 15px; position: relative; }
        .section-title { border-left: 5px solid #dc3545; padding-left: 15px; margin-bottom: 25px; font-weight: bold; color: #dc3545; }
        .info-box { background: #fff5f5; border: 1px solid #feb2b2; padding: 15px; border-radius: 10px; font-size: 0.9rem; color: #c53030; }
    </style>
</head>
<body>

<div class="form-card shadow">
    <h3 class="text-center fw-bold text-danger mb-4">
        {% if data and data.app_id %} <i class="bi bi-pencil-square"></i> ì˜ë£Œë¹„ ì‹ ì²­ ìˆ˜ì • {% else %} ğŸ¥ ì˜ë£Œë¹„ ì§€ì› ì‹ ì²­ì„œ {% endif %}
    </h3>

    <form id="medicalForm" enctype="multipart/form-data">
        <input type="hidden" name="app_id" value="{{ data.app_id if data and data.app_id else '' }}">
        <input type="hidden" name="type" value="ì˜ë£Œë¹„ì§€ì›">
        
        <div class="section-title">1. ì‹ ì²­ì¸ ì •ë³´</div>
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <label class="fw-bold small">ì„±ëª…</label>
                <input type="text" name="user_name" class="form-control bg-light" value="{{ data.ì„±ëª… if data else user_name }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">ì‚¬ë²ˆ</label>
                <input type="text" name="user_id" class="form-control bg-light" value="{{ data.ì‚¬ë²ˆ if data else user_id }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">ë¶€ì„œ</label>
                <input type="text" name="user_dept" class="form-control bg-light" value="{{ data.ë¶€ì„œ if data else user_dept }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">ì§ê¸‰</label>
                <input type="text" name="position" class="form-control bg-light" value="{{ data.ì§ê¸‰ if data else user_rank }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">ì…ì‚¬ì¼</label>
                <input type="text" name="joinDate" class="form-control bg-light" value="{{ data.ì…ì‚¬ì¼ if data else user_join_date }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">ì „í™”ë²ˆí˜¸</label>
                <input type="text" name="phone" class="form-control bg-light" value="{{ data.ì „í™”ë²ˆí˜¸ if data else '' }}" readonly required>
            </div>
        </div>

        <div class="section-title d-flex justify-content-between align-items-center">
            2. ì§„ë£Œ ìƒì„¸ë‚´ì—­
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="addRow()"><i class="bi bi-plus-circle"></i> ë‚´ì—­ ì¶”ê°€</button>
        </div>
        
        <div id="rowContainer"></div>

        <div class="my-4 p-3 bg-light rounded d-flex justify-content-between align-items-center border">
            <h5 class="m-0 fw-bold">ì´ ì‹ ì²­ ê¸ˆì•¡ í•©ê³„</h5>
            <div class="input-group w-50">
                <input type="number" name="amount" id="totalAmt" class="form-control fw-bold text-end text-danger" value="{{ data.amount if data.amount else (data.ì‹ ì²­ê¸ˆì•¡ if data.ì‹ ì²­ê¸ˆì•¡ else 0) }}" readonly>
                <span class="input-group-text bg-white">ì›</span>
            </div>
        </div>

        <div class="mb-4">
            <label class="fw-bold mb-1 small">ì§€ê¸‰ ê³„ì¢Œë²ˆí˜¸ <span class="text-danger">*</span></label>
            <div class="row g-2">
                <div class="col-md-4">
                    <select id="bankSel" class="form-select" onchange="syncAcct()" required>
                        <option value="">-- ì€í–‰ ì„ íƒ --</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" id="acctNum" class="form-control" placeholder="ê³„ì¢Œë²ˆí˜¸ (ìˆ«ìë§Œ)" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9]/g,'');syncAcct();" required>
                </div>
                <div class="col-md-4">
                    <input type="text" id="acctHolder" class="form-control" placeholder="ì˜ˆê¸ˆì£¼" oninput="syncAcct();" required>
                </div>
            </div>
            <input type="hidden" name="account" id="account" value="{{ data.account if data.account else (data.ê³„ì¢Œë²ˆí˜¸ if data.ê³„ì¢Œë²ˆí˜¸ else '') }}">
            <small class="text-muted mt-1 d-block"><i class="bi bi-info-circle"></i> ì€í–‰ ì„ íƒ â†’ ê³„ì¢Œë²ˆí˜¸ ì…ë ¥ â†’ ì˜ˆê¸ˆì£¼ ì…ë ¥</small>
        </div>

        <div class="section-title">3. ì¦ë¹™ì„œë¥˜ ì²¨ë¶€</div>
        <div class="row g-3 mb-4">
            <div class="col-12">
                <div class="info-box mb-3">
                    <i class="bi bi-info-circle-fill"></i> 
                    <b>ì•ˆë‚´ì‚¬í•­:</b> â€» ì²¨ë¶€ì„œë¥˜: ì§„ë‹¨ì„œ(í˜¹ì€ì†Œê²¬ì„œ), ì§„ë£Œë¹„ ì˜ìˆ˜ì¦ ë“± ì˜ë£Œë¹„ ì§€ì¶œì„ í™•ì¸í•  ìˆ˜ ìˆëŠ” ì¦ë¹™ <br>
                    â€» ë³¸ì¸ í˜¹ì€ ì§ê³„ì¡´ë¹„ì† ì¤‘ ì¥ì• ì¸ì´ ìˆëŠ” ê²½ìš° ì¥ì• ì¸ ì˜ë£Œë¹„ëŠ” ë³„ë„ë¡œ ì§€ì›ì‹ ì²­ì„œë¥¼ ì‘ì„±(ì¥ì• ë“±ê¸‰ì„í™•ì¸í• ìˆ˜ìˆëŠ”ì„œë¥˜ì²¨ë¶€)
                </div>
                <input type="file" name="attachment" class="form-control">
                {% if data and data.ì²¨ë¶€íŒŒì¼ %}
                <div class="mt-2 small text-muted">ê¸°ì¡´ íŒŒì¼: <span class="text-danger fw-bold">{{ data.ì²¨ë¶€íŒŒì¼ }}</span></div>
                {% endif %}
            </div>
        </div>

        <div class="section-title">4. ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜</div>
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-body bg-light small" style="max-height: 150px; overflow-y: auto;">
                <p class="fw-bold mb-1">[ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ëŒ€í•œ ë™ì˜]</p>
                <p class="mb-2">LOFA ì‚¬ë‚´ê·¼ë¡œë³µì§€ê¸°ê¸ˆ ì§€ì› ì‹ ì²­ê³¼ ê´€ë ¨í•˜ì—¬ ì•„ë˜ì™€ ê°™ì´ ê·€í•˜ì˜ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘ ë° ì´ìš©í•˜ê³ ì í•©ë‹ˆë‹¤.</p>
                <ul class="mb-2">
                    <li><strong>ìˆ˜ì§‘í•­ëª©:</strong> ì„±ëª…, ì‚¬ë²ˆ, ë¶€ì„œ, ì§ê¸‰, ì „í™”ë²ˆí˜¸, ì…ì‚¬ì¼, ê³„ì¢Œë²ˆí˜¸, ì‹ ì²­ ê¸ˆì•¡ ë° ì‚¬ìœ , ì¦ë¹™ì„œë¥˜ ë‚´ í¬í•¨ëœ ê°œì¸ì •ë³´</li>
                    <li><strong>ìˆ˜ì§‘ëª©ì :</strong> ë³µì§€ê¸°ê¸ˆ ì§€ì› ëŒ€ìƒ í™•ì¸, ì§€ê¸‰ ì‹¬ì‚¬ ë° ì²˜ë¦¬, ê²°ê³¼ í†µì§€, ê¸°ê¸ˆ ìš´ì˜ í†µê³„ ë¶„ì„</li>
                    <li><strong>ë³´ìœ  ë° ì´ìš©ê¸°ê°„:</strong> ë³µì§€ê¸°ê¸ˆ ìš´ì˜ ê·œì • ë° ê´€ë ¨ ë²•ë ¹(ê·¼ë¡œë³µì§€ê¸°ë³¸ë²• ë“±)ì— ë”°ë¥¸ ë³´ì¡´ ê¸°ê°„ ì¢…ë£Œ ì‹œê¹Œì§€</li>
                </ul>
                <p class="mb-0 text-muted">â€» ê·€í•˜ëŠ” ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ëŒ€í•œ ë™ì˜ë¥¼ ê±°ë¶€í•  ê¶Œë¦¬ê°€ ìˆìŠµë‹ˆë‹¤. ë‹¤ë§Œ, ë™ì˜ë¥¼ ê±°ë¶€í•  ê²½ìš° ë³µì§€ê¸°ê¸ˆ ì§€ì› ì‹ ì²­ ë° ì§€ê¸‰ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            <div class="card-footer bg-white border-top-0">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="privacyConsent" name="privacy_consent" required>
                    <label class="form-check-label fw-bold" for="privacyConsent">
                        ìœ„ì˜ ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜)
                    </label>
                </div>
            </div>
        </div>

        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-danger btn-lg shadow fw-bold">
                {% if data and data.app_id %} <i class="bi bi-check2-circle"></i> ìˆ˜ì • ì™„ë£Œ ë° ì¬ì œì¶œ {% else %} <i class="bi bi-send-check"></i> ì˜ë£Œë¹„ ì‹ ì²­ì„œ ì œì¶œí•˜ê¸° {% endif %}
            </button>
            <a href="/my_status" class="btn btn-outline-secondary">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const BANKS=['KBêµ­ë¯¼ì€í–‰','ì‹ í•œì€í–‰','ìš°ë¦¬ì€í–‰','í•˜ë‚˜ì€í–‰','NHë†í˜‘ì€í–‰','IBKê¸°ì—…ì€í–‰','ì¹´ì¹´ì˜¤ë±…í¬','í† ìŠ¤ë±…í¬','SCì œì¼ì€í–‰','ì”¨í‹°ì€í–‰','ëŒ€êµ¬ì€í–‰','ë¶€ì‚°ì€í–‰','ê´‘ì£¼ì€í–‰','ì „ë¶ì€í–‰','ê²½ë‚¨ì€í–‰','ì œì£¼ì€í–‰','KDBì‚°ì—…ì€í–‰','ìˆ˜í˜‘ì€í–‰','ìƒˆë§ˆì„ê¸ˆê³ ','ì‹ í˜‘','ìš°ì²´êµ­','iMë±…í¬(êµ¬DGB)','ê¸°íƒ€'];
    function initBankSelect(){const sel=document.getElementById('bankSel');if(!sel)return;BANKS.forEach(b=>{const o=document.createElement('option');o.value=b;o.textContent=b;sel.appendChild(o);});}
    function syncAcct(){const b=(document.getElementById('bankSel')||{value:''}).value;const n=(document.getElementById('acctNum')||{value:''}).value;const h=(document.getElementById('acctHolder')||{value:''}).value;const hidden=document.getElementById('account');const cleanAcct=n.replace(/[^0-9]/g,'');if(hidden)hidden.value=(b&&cleanAcct&&h)?`${b}/${cleanAcct}/${h.trim()}`:''; }
    function loadAcct(str){if(!str)return;const p=str.split('/');const sel=document.getElementById('bankSel');if(sel&&p[0]){sel.value=p[0];if(!sel.value){const o=new Option(p[0],p[0],true,true);sel.appendChild(o);sel.value=p[0];}}const num=document.getElementById('acctNum');if(num&&p[1])num.value=p[1];const holder=document.getElementById('acctHolder');if(holder&&p[2])holder.value=p[2];syncAcct();}

    // ì§„ë£Œ ë‚´ì—­ ì¤„ ì¶”ê°€ í•¨ìˆ˜
    function addRow(hospital = '', date = '', price = '') {
        const container = document.getElementById('rowContainer');
        const div = document.createElement('div');
        div.className = 'medical-row shadow-sm';
        div.innerHTML = `
            <button type="button" class="btn-close position-absolute" style="top:10px;right:10px;" onclick="this.parentElement.remove(); calcTotal();"></button>
            <div class="row g-2">
                <div class="col-md-4"><label class="small text-muted">ì§„ë£Œê¸°ê´€</label><input type="text" class="form-control med_org" value="${hospital}" required></div>
                <div class="col-md-4"><label class="small text-muted">ì§„ë£Œì¼ì</label><input type="date" class="form-control med_date" value="${date}" required></div>
                <div class="col-md-4"><label class="small text-muted">ê¸ˆì•¡</label><input type="number" class="form-control med_amount" oninput="calcTotal()" value="${price}" required></div>
            </div>`;
        container.appendChild(div);
        calcTotal();
    }

    // í•©ê³„ ê³„ì‚° í•¨ìˆ˜
    function calcTotal() {
        let sum = 0;
        document.querySelectorAll('.med_amount').forEach(i => sum += (parseInt(i.value) || 0));
        document.getElementById('totalAmt').value = sum;
    }

    // í˜ì´ì§€ ë¡œë”© ì‹œ ê¸°ì¡´ ë°ì´í„° ë³µêµ¬
    window.onload = function() {
        initBankSelect();
        loadAcct(`{{ data.account if data and data.account else (data.ê³„ì¢Œë²ˆí˜¸ if data and data.ê³„ì¢Œë²ˆí˜¸ else '') }}`);
        const rawDetail = `{{ data.detail if data.detail else (data.ì„¸ë¶€ë‚´ìš© if data.ì„¸ë¶€ë‚´ìš© else '') }}`;
        if (rawDetail) {
            if (rawDetail.includes('||')) {
                const records = rawDetail.split('||');
                records.forEach(record => {
                    const parts = record.split('|');
                    if (parts.length === 3) addRow(parts[0], parts[1], parts[2]);
                });
            } else if (rawDetail.includes('ë‚´ìš©:')) {
                const contentPart = rawDetail.split('ë‚´ìš©:')[1];
                if (contentPart && contentPart.includes('||')) {
                    const records = contentPart.split('||');
                    records.forEach(record => {
                        const parts = record.split('|');
                        if (parts.length === 3) addRow(parts[0], parts[1], parts[2]);
                    });
                } else {
                    addRow();
                }
            } else {
                addRow();
            }
        } else {
            addRow();
        }
        calcTotal();
    };

    // ì œì¶œ ì²˜ë¦¬
    document.getElementById('medicalForm').onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        let medicalDetails = [];
        document.querySelectorAll('.medical-row').forEach(row => {
            const org = row.querySelector('.med_org').value;
            const date = row.querySelector('.med_date').value;
            const amt = row.querySelector('.med_amount').value;
            if(org && date && amt) medicalDetails.push(`${org}|${date}|${amt}`);
        });
        formData.append('detail_text', medicalDetails.join('||'));

        try {
            const res = await fetch('/submit', { method: 'POST', body: formData });
            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${res.status}): ${errorText.substring(0, 100)}`);
            }
            const result = await res.json();
            
            if(result.status === 'success') {
                alert(result.message || 'ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/my_status';
            } else {
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + result.message);
            }
        } catch (err) {
            console.error('Submission error:', err);
            alert('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
        }
    };
</script>
</body>
</html>
