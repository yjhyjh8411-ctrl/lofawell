<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¥í•™ê¸ˆ ì§€ì› ì‹ ì²­ - LOFA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background: #f8f9fa; padding: 30px; font-family: 'Malgun Gothic', sans-serif; }
        .form-card { background: white; border-radius: 15px; padding: 40px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); max-width: 950px; margin: auto; }
        .scholar-row { background: #fcfdff; border: 1px solid #cfe2ff; padding: 20px; border-radius: 10px; margin-bottom: 15px; position: relative; }
        .section-title { border-left: 5px solid #0d6efd; padding-left: 15px; margin-bottom: 25px; font-weight: bold; color: #0d6efd; }
        .info-box { background: #eef6ff; border: 1px solid #b8daff; padding: 15px; border-radius: 10px; font-size: 0.9rem; color: #004085; }
    </style>
</head>
<body>

<div class="form-card shadow">
    <h3 class="text-center fw-bold text-primary mb-4">
        {% if data and data.app_id %} ğŸ“ ì¥í•™ê¸ˆ ì‹ ì²­ ë‚´ì—­ ìˆ˜ì • {% else %} ğŸ“ ì¥í•™ê¸ˆ ì§€ì› ì‹ ì²­ì„œ {% endif %}
    </h3>

    <form id="scholarshipForm" enctype="multipart/form-data">
        <input type="hidden" name="app_id" value="{{ data.app_id if data and data.app_id else '' }}">
        <input type="hidden" name="type" value="ì¥í•™ê¸ˆì§€ì›">
        
        <div class="section-title">1. ì‹ ì²­ì¸ ì •ë³´</div>
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <label class="fw-bold small">ì„±ëª…</label>
                <input type="text" name="user_name" class="form-control bg-light" value="{{ data.ì„±ëª… if data else user_name }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">ì‚¬ë²ˆ</label>
                <input type="text" name="user_id" class="form-control bg-light" value="{{ data.ì‚¬ë²ˆ if data else user_id }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">ë¶€ì„œ</label>
                <input type="text" name="user_dept" class="form-control bg-light" value="{{ data.ë¶€ì„œ if data else user_dept }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">ì§ê¸‰</label>
                <input type="text" name="position" class="form-control bg-light" value="{{ data.ì§ê¸‰ if data else user_rank }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">ì…ì‚¬ì¼</label>
                <input type="text" name="joinDate" class="form-control bg-light" value="{{ data.ì…ì‚¬ì¼ if data else user_join_date }}" readonly>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small">ì „í™”ë²ˆí˜¸</label>
                <input type="text" name="phone" class="form-control bg-light" value="{{ data.ì „í™”ë²ˆí˜¸ if data else '' }}" readonly required>
            </div>
        </div>

        <div class="section-title d-flex justify-content-between align-items-center">
            2. ì¥í•™ê¸ˆ ìƒì„¸ ë‚´ì—­ (ìë…€/ë³¸ì¸)
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addOne()"><i class="bi bi-plus-circle"></i> ë‚´ì—­ ì¶”ê°€</button>
        </div>
        
        <div id="rowContainer"></div>

        <div class="my-4 p-3 bg-light rounded d-flex justify-content-between align-items-center border">
            <h5 class="m-0 fw-bold text-dark">ì´ ì‹ ì²­ ê¸ˆì•¡ í•©ê³„</h5>
            <div class="input-group w-50 shadow-sm">
                <input type="number" name="amount" id="totalAmt" class="form-control fw-bold text-end text-primary" value="{{ data.ì‹ ì²­ê¸ˆì•¡ if data else 0 }}" readonly>
                <span class="input-group-text bg-white">ì›</span>
            </div>
        </div>

        <div class="mb-4">
            <label class="fw-bold small">ì§€ê¸‰ ê³„ì¢Œë²ˆí˜¸ (ì€í–‰/ë²ˆí˜¸/ì˜ˆê¸ˆì£¼)</label>
            <input type="text" name="account" class="form-control" value="{{ data.ê³„ì¢Œë²ˆí˜¸ if data else '' }}" placeholder="ì˜ˆ: ì‹ í•œì€í–‰ / 110-000-000000 / í™ê¸¸ë™" required>
        </div>

        <div class="section-title">3. ì¦ë¹™ì„œë¥˜ ì²¨ë¶€</div>
        <div class="row g-3 mb-4">
            <div class="col-12">
                <div class="info-box mb-3">
                    <i class="bi bi-info-circle-fill"></i> 
                    <b>ì•ˆë‚´ì‚¬í•­:</b> ì¬í•™ì¦ëª…ì„œ ë° ë“±ë¡ê¸ˆ ë‚©ì… ì˜ìˆ˜ì¦ì„ ì²¨ë¶€í•´ ì£¼ì„¸ìš”.<br>
                    (íŒŒì¼ì´ ì—¬ëŸ¬ ê°œì¸ ê²½ìš° í•˜ë‚˜ì˜ PDF ë˜ëŠ” ì••ì¶•íŒŒì¼(ZIP)ë¡œ ë¬¶ì–´ì„œ ì œì¶œ ê¶Œì¥)
                </div>
                <input type="file" name="attachment" class="form-control">
                {% if data and data.ì²¨ë¶€íŒŒì¼ %}
                <div class="mt-2 small text-muted">ê¸°ì¡´ íŒŒì¼: <span class="text-primary fw-bold">{{ data.ì²¨ë¶€íŒŒì¼ }}</span></div>
                {% endif %}
            </div>
        </div>

        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary btn-lg shadow fw-bold">
                {% if data and data.app_id %} <i class="bi bi-check2-circle"></i> ìˆ˜ì • ì™„ë£Œ ë° ì¬ì œì¶œ {% else %} <i class="bi bi-send"></i> ì¥í•™ê¸ˆ ì‹ ì²­ì„œ ì œì¶œí•˜ê¸° {% endif %}
            </button>
            <a href="/my_status" class="btn btn-outline-secondary">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function calc() {
        let sum = 0;
        document.querySelectorAll('.s_price').forEach(i => sum += (parseInt(i.value) || 0));
        document.getElementById('totalAmt').value = sum;
    }

    function addOne(target='', rel='ìë…€', school='', price='') {
        const container = document.getElementById('rowContainer');
        const div = document.createElement('div');
        div.className = 'scholar-row shadow-sm position-relative';
        div.innerHTML = `
            <button type="button" class="btn btn-close position-absolute" style="top:10px;right:10px;" onclick="this.parentElement.remove(); calc();"></button>
            <div class="row g-2">
                <div class="col-md-3"><label class="small text-muted">ëŒ€ìƒì ì„±ëª…</label><input type="text" class="form-control s_target" value="${target}" required></div>
                <div class="col-md-2"><label class="small text-muted">ê´€ê³„</label><select class="form-select s_rel"><option value="ìë…€" ${rel==='ìë…€'?'selected':''}>ìë…€</option><option value="ë³¸ì¸" ${rel==='ë³¸ì¸'?'selected':''}>ë³¸ì¸</option></select></div>
                <div class="col-md-4"><label class="small text-muted">í•™êµëª… ë° í•™ë…„</label><input type="text" class="form-control s_school" value="${school}" required></div>
                <div class="col-md-3"><label class="small text-muted">ì‹ ì²­ ê¸ˆì•¡</label><input type="number" class="form-control s_price" value="${price}" oninput="calc()" required></div>
            </div>`;
        container.appendChild(div);
        calc();
    }

    window.onload = function() {
        const savedDetail = `{{ data.ì„¸ë¶€ë‚´ìš© if data else '' }}`;
        if (savedDetail) {
            const rows = savedDetail.split('||');
            rows.forEach(r => {
                const cols = r.split('|');
                if(cols.length >= 3) addOne(cols[0], cols[1], cols[2], cols[3]);
            });
        } else {
            addOne();
        }
    };

    document.getElementById('scholarshipForm').onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        let details = [];
        document.querySelectorAll('.scholar-row').forEach(row => {
            const t = row.querySelector('.s_target').value;
            const r = row.querySelector('.s_rel').value;
            const s = row.querySelector('.s_school').value;
            const p = row.querySelector('.s_price').value;
            if(t) details.push(`${t}|${r}|${s}|${p}`);
        });
        formData.append('detail_text', details.join('||'));

        try {
            const res = await fetch('/submit', { method: 'POST', body: formData });
            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${res.status}): ${errorText.substring(0, 100)}`);
            }
            const result = await res.json();
            
            if(result.status === 'success') {
                alert(result.message || 'ì¥í•™ê¸ˆ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/my_status'; 
            } else {
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + result.message);
            }
        } catch (err) {
            console.error('Submission error:', err);
            alert('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
        }
    };
</script>
</body>
</html>
